#!/usr/bin/env ruby

require "rubygems"
require "bundler/setup"
require "cmux"

require "pp"

mux = CMUX::MUX.new "/dev/ttyUSB0"

loop do
  status = mux.allocate 1

  puts "Status channel: #{status.device}"

  status.open do |io|
    info_got = false

    chatter = CMUX::ModemChatter.new io
    chatter.command("+CGMM;+CGMI;+CGMR") do |resp|
      if resp.failure?
        warn "command failed"
      else
        pp resp.response
      end

      info_got = true
    end

    until info_got
      CMUX::ModemChatter.poll chatter
    end
  end

  status.close


  sleep 1
end

mux.close

